# BOT SLACK

### ВАЖНО
* `botSlack` используется для взаимодействия с мессенджером `Slack` через API
* для подключения к `Slack` нужно задать переменные:
    * `mysql.atlas.var.botSlack.token` - получить в настройках `Slack`
    * `mysql.atlas.var.botSlack.id` - сообщения от системы приходят с этим id, т.е. поле user=id (чтобы боту отсеивать свои сообщения)
* принцип работы `botSlack`:
    * читает сообщение из `mysql.atlas.bot` с полем `show_slack`=0 - это значит неотправленное сообщение (сообщения сюда помещает `baseBot`). Частота опроса задается в переменной `mysql.atlas.var.botSlack.admins` в секундах
    * отправляет сообщение в каналы, определенные политикой `mysql.atlas.bot_type`
    * записывает в поле `slack_ts` идентификаторы размещенных сообщений
* для выполнения некоторых команд нужны права администратора или менеджера
* администраторы могут управлять системой через Slack
* менеджеры могут ставить/удалять контроль
* `ID` администраторов и менеджеров задаются в переменных `mysql.atlas.var.botSlack.admins` и `mysql.atlas.var.botSlack.managers` соответственно. Можно через запятую.
* Чтобы узнать свой `ID` нужно набрать в `Slack` команду `info`

## КОМАНДЫ В `SLACK`
* `?` - справка
* `info` `инфо` - информация о пользователе
* `log [N]` `лог [N]` - логи всех процессов, последние N строк, N=3 (можно набирать на любой раскладке клавиатуры, например, `kju`)
* `start module_name` - запустить модуль
* `stop module_name` - остановить модуль
* `restart module_name` - перезапустить модуль
* `verify module_name` - если модуль не запущен, то запустить
* `control[+|-] text[|text2|...]` `контроль[+|-] text[|text2|...]` - поставить на контроль/снять с контроля `textN`, название объекта `text`, результаты направлять канал, из которого послано сообщение
* `report [N]` `отчет [N]` - сформировать отчет типа N. Если N=`?` - показать список доступных отчетов

---

# ВЗАИМОДЕЙСТВИЕ С `VIBER`
### ВАЖНО
* сообщения в `Viber` дублируются со `Slack`
* для взаимодействия с webhook-сервером (проект `remvb`) используется модуль `fun.funViber.py`
* если идут две схожие новости подряд, то не успевает вторую блокировать из-за параллельной работы процессов, они отсеваются в `remvb`
* перехват сообщений для `Viber` осуществляется после `ioGet` и `ioSend` (так как `ioGet` не перехватывает сообщения самой системы)
для отладки перехвата установить `botSlackClass.funViberSend.debug = True`
* нужно задать переменную `mysql.atlas.var.botSlack.viber`:
    * `forward` - тип пересылки сообщения:
        * `reaction` - пересылка сообщения только при отметке его значками (`reaction`), перечисленными в `slackReaction`, если `slackReaction` не задано - любой значок
        * `auto`     - пересылка сообщения автоматически при размещении его в канале
    * `firstOnly` - пересылка только основного (первого) сообщения. Вложенный сообщения (`replies`) игнорируются. Имеет смысл только при `forward=auto`
    * `slackReaction` - список значков, на которые реагировать, если не задано - на любой
    * `slackChannels` - список каналов, с который производится пересылка сообщений. Если не задать, то любой канал. Лучше задать
    * `slackUsers` - список ID пользователей, сообщения которых пересылаются, смотреть в логах. Если не задать, то любой пользователь
    * `viberURL` - URL webhook-сервера (проект `remvb`)
    * `viberID` - идентификатор задачи в логах. Можно не задавать - лог вестись не будет (не запускается специальный поток в `fun.funViber.py`)

Пример:
```json
[
{
"forward": "reaction",
"slackReaction": [],
"slackChannels": ["G46U0JJJ0"],
"slackUsers": [],
"viberURL": "https://remvb.herokuapp.com/",
"viberID": "viber1"
},
{
"forward": "auto",
"slackChannels": ["GJ9HEAC0L"],
"viberURL": "https://remvb.herokuapp.com/",
"viberID": "viber1"
},
{
"forward": "auto",
"firstOnly": true,
"slackChannels": ["G6YCSQ9M0", "CJA7GC52R"],
"viberURL": "https://remvb3.herokuapp.com/",
"viberID": "viber3"
}
]
```

---

# ВЗАИМОДЕЙСТВИЕ С `mlServerText`
### ВАЖНО
* `botSlack` использует `mlServerText` для интеллектуального поиска похожих текстов и последующей их группировки
* нужно задать переменную `mysql.atlas.var.botSlack.mlServerText`:
    * `host` `port`- ip и порт сервера `mlServerText`
    * `sim_min` - минимально допустимый коэффициент подобия текста (1.0 - 100% совпадение). Если 0 - сервер НЕ ИСПОЛЬЗУЕТСЯ
    * `sim_correct` - коррекция коэффициента подобия - улучшает сравнения для коротких текстов
    * `period` - количество часов, за который ищутся повторы текста

Пример:
```json
"host":        "192.168.30.111",
"port":        5000,
"sim_min":     0.28,
"sim_correct": true,
"period":      12
```
